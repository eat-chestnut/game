GDevelop + Windsurf Codex — v8 升级提示（自适应当前仓库，先读取升级报告与配置）
================================================================================
仓库：https://github.com/eat-chestnut/game
前置：已完成 v6 / v6.1（装备系统）/ v7（套装、预设、锁定重铸等）。
本轮目标：在**不破坏既有平衡与硬约束**的前提下，自动读取升级报告与配置，修复遗留问题、补强装备&套装体验，新增成就&离线榜单&输入映射等功能，并输出可审计结果。实现与本提示冲突时，**直接重构覆盖**；不得要求人工点击。

【自适应输入（务必首先执行）】
1) 读取并解析根目录中下列文件（按优先级）：
   - `V6_V6.1_UPGRADE_REPORT.md`
   - `V7_UPGRADE_REPORT.md`（如存在）
   - `CHANGELOG.md`（读取 `Unreleased` 与最近两版的段落）
   - `docs/equipment_sets.md`（作为套装真值表）
   - `skill_config.json`、`equipment_config.json`（现行数据结构）
2) 汇总为“v7→v8 待改清单”，分为：Bugs/Regression、Polish/UX、Perf/Memory、New Features。
3) 逐项落地。对报告未提及但代码中可复现的问题，也要补充并修复。

【执行模式】
- 全自动创建/修改/覆盖 场景、External Events、对象、资源与变量；
- 每轮必须打印：①变更清单 ②QA自测报告（含 FPS P50/P95 与断言结果）③与报告映射的完成度表；
- 如检测到 `skill_config.json` / `equipment_config.json` / 存档结构与实现不一致：启用“适配层 + 迁移脚本”，打印一次性兼容日志。

================================================================================
一、回归体检（硬约束，必须继续保持正确）
--------------------------------------------------------------------------------
1) 冷却/攻速：`fireRate` 初始 2.0s；使用 `TimeDelta` 递减；`fireRate ≥ max(minFireRate, capFireRate)`（默认 0.60s；商店/装备提升后可到 0.55s 但不得再低）。
2) 形态乘区：连发 vs 散射 → `totalMultiplier = max(multi_total, scatter_total)`；永不相乘。
3) 分裂：`isSplitChild=true` 的小弹不继承形态技能；仅承接数值乘区；主弹分裂 CD=30ms；小弹伤害= 60% × 数值乘区（再乘装备 `splitChildPct`，但总上限 +30%）。
4) 穿透/反弹：穿透后伤害 ×0.90（不少于初伤 50%）；反弹后 ×0.85（±4°）。
5) 升级暂停：弹出时 `isPaused=true` 冻结生成/计时；选中后恢复；UI 不穿透/不重影；Boss 宝箱与升级面板队列化顺序：**宝箱优先**。
6) 波次：`WaveTimer` 每 30s：`enemySpeed×1.04 / enemyHP×1.06 / spawnRate×0.97`（地板 0.30s）。
7) 泄漏防护：子弹寿命 ≤2s；分裂弹 ≤50；同屏敌 ≤80。
8) 音频：首次交互初始化；前后台恢复 BGM；设置滑条实时持久化。
9) 存档：包含 `SkillState/level/coins/音量/最高分/装备/残片/预设/设置` 并成功迁移。

================================================================================
二、v8 需修复/打磨（结合报告逐条对照）
--------------------------------------------------------------------------------
A. 计时器与“引用计数型暂停”
- 继续使用 `PauseSystem(counter)`：面板/教程/Boss/失焦分别 +1/-1；任何计数>0 时冻结生成与计时器。
- 防重：`fireCooldown/NearestTimer/WaveTimer/BossSkillTimer/DailyTimer` 仅有一份；加入“守护事件”。

B. 装备/套装体验
- 预设（Loadouts）切换时：**增量更新融合缓存**（避免整表重算卡顿）；HUD 延迟 ≤ 1 帧。
- Reroll with Locks：成本 = 基础 `rerollCost × 锁定数`；修复速点导致的重复结算/碎片负值。
- 背包满：提供“批量分解”入口（默认不包含 Epic/Legend，且尊重锁定）。
- `equipment_config.json` 缺 `sets` 时从 `docs/equipment_sets.md` 反向生成最小可用 sets 区块。

C. i18n 与可访问性
- 缺键回退中文；高对比/色盲主题同时作用于装备/套装 UI；移动端≥44px 命中区保持。

D. 性能与内存
- 背包虚拟滚动；对象池命中率跟踪；大规模掉落（1000 次统计）与 Boss 弹幕分帧。

================================================================================
三、v8 新增功能
--------------------------------------------------------------------------------
1) **成就系统（Achievements）**
   - 本地成就：击杀阈值/波次/最高分/无伤时长/套装完成/极限攻速触顶等；
   - HUD 弹出小徽章 + 主菜单“成就”面板；
   - 成就进度持久化；写入 `achievements.json`（不存在则创建默认表）。

2) **离线排行榜（Local Leaderboard）**
   - 记录“日榜/周榜/历史最佳”三种榜单；支持 Daily Challenge 维度；
   - 提供“分享种子/回放码”；QA 可重放 60s 验证分数。

3) **输入映射（Input Remap）**
   - 设置页允许玩家选择：手柄/键鼠/触摸的关键操作映射（暂停、面板、技能确认等）；
   - 存档保存 `inputBindings`；UI 焦点导航完整闭环。

4) **装备 & 套装的调试页（开发者开关）**
   - 展示融合后的 `EquipMerged`、套装激活状态、乘区/上限 clamp 的中间值；
   - 一键压测：随机生成背包满+套装齐；统计 P50/P95。

5) **每日试炼（Daily Challenge）补强**
   - 增加两条规则类型：`EliteDensity+`（精英密度上调但掉率微升）、`PlayerHP-`（玩家生命削减，最小 1HP 保底）；
   - HUD 标记今日规则；与离线榜单的“日榜”绑定。

================================================================================
四、配置与数据（自动补全/迁移）
--------------------------------------------------------------------------------
- 新增（不存在则创建）：
  - `achievements.json`（基础成就表，含 id/name/desc/trigger/threshold/reward）
  - `leaderboard.json`（`daily/weekly/allTime` 三段结构，含条目上限与排序规则）
- 扩展 `equipment_config.json`：若缺 `sets` 从文档生成；若缺 `ui.loadouts.count` → 默认 3；若缺 `ui.lootBeams` → 默认 true。
- `skill_config.json`：校验字段名与实现兼容，必要时写适配层。

================================================================================
五、事件与代码要点（按需覆盖旧实现）
--------------------------------------------------------------------------------
EquipFusion（融合缓存）：
- 顺序：基础 → 技能/商店 → 装备 affix → 套装 set2/set4 → clamp（攻速/穿透/反弹/分裂）→ 形态（连发/散射 max）→ 输出 ShotPattern 与 perBulletDamage。
- 仅在输入（技能/商店/装备/套装/设置）发生变化时重算；Loadouts 切换走差量更新。

Achievements：
- 提供 `Achieve.PushEvent(type, value)` 接口（击杀/波次/无伤时间/套装数/攻速触顶等）；达成→吐司+存档更新。

Leaderboard：
- 回合结束写入榜单；同回放码合并；日/周榜按日期桶化；本地持久化 JSON。

Input Remap：
- 生成 `inputBindings` 结构；UI 焦点导航支持手柄 A/B/X/Y 和 Start/Menu；触摸长按防抖 200ms。

QA & Dev：
- 新增按钮：成就触发模拟、离线榜单写入模拟、背包满压测、装备融合可视化、回放 60s 检验。

================================================================================
六、性能优化（v8）
--------------------------------------------------------------------------------
- 虚拟滚动、分帧生成、对象池命中率≥70%（低性能模式可≥60%）。
- 融合缓存差量更新；HUD Diff 限制为逐帧一个批次。

================================================================================
七、自动断言（必须全部 PASS）
--------------------------------------------------------------------------------
- 攻速下限、连发×散射取 max、分裂不再分裂、穿透/反弹衰减与 clamp 生效；
- 装备乘区≤30%，穿透≤3、反弹≤2、splitChildBonus≤+30%；套装奖励不突破硬约束；
- Loadouts 切换后一帧内数值与 HUD 一致；
- 背包满批量分解不误伤 Epic/Legend 与锁定；
- 成就触发正确去重（每成就一次）；离线榜单同回放码合并成功；
- P95 FPS ≥ 50（低性能模式下可 ≥45）；
- Daily Challenge 的“日榜”仅统计当日规则场次。

================================================================================
八、输出（每轮必须打印）
--------------------------------------------------------------------------------
1) 变更清单（新增/修改/覆盖）。
2) 自测报告：
   - QA：Spawn50 / LevelUpTo10 / SpreadTest / 压力测试 / 触摸连点 / RNG 重放 / 背包满 / 成就模拟 / 榜单写入 的 avg & p95 FPS 与断言；
   - 存档迁移结果（成功/失败与原因）；
   - 与报告映射的完成度表（Bugs/Polish/Perf/New）。
3) 若仍有 TODO → 列出并在下一轮自动完成。

================================================================================
九、CHANGELOG & 版本自动化（若存在则启用）
--------------------------------------------------------------------------------
- 若根目录存在 `CHANGELOG.template.md` 与 `Codex_Changelog_AutoPrompt.txt`，执行完自动更新 `CHANGELOG.md` 与 `VERSION`，并以 Conventional Commits 提交。

（完）
