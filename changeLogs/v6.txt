GDevelop + Windsurf Codex — v6 升级提示（在当前版本基础上自动执行，自动读取 V5 报告）
================================================================================
仓库：https://github.com/eat-chestnut/game
目标：在**当前版本**基础上，自动读取 `V5_UPGRADE_REPORT.md` 与现有源码，进行回归体检、修复 v5 遗留问题、继续功能/性能/可访问性优化，并输出可审计结果。
若现有实现与本提示冲突，请直接重构覆盖；全程不得要求人工点击。

【自适应输入】
- 第一步务必执行：读取并解析仓库根的 `V5_UPGRADE_REPORT.md`（若缺失则读取 `CHANGELOG.md` 的 Unreleased 与最近版本段落）。
- 从报告中抽取：
  - Bugs/Issues（按严重度）
  - 已完成与部分完成的功能
  - 待办 TODO / Known Limitations / Next
- 生成“v5→v6 待改清单”，逐项落地；对报告中未提及但在代码里实测存在的问题，也要补充并修复。

【统一执行模式】
- 全自动创建/修改/覆盖 场景、对象、External Events、资源与变量；
- 每轮输出：变更清单 + 自测报告（含 FPS 分位与断言结果）+ 从 v5 报告映射的完成度；若仍有 TODO，下一轮自动完成；
- 若检测到 `skill_config.json` 或存档结构与实现不一致，启用“适配层 + 迁移脚本”，并打印一次性兼容日志。

================================================================================
一、回归体检（必须保持正确的既有特性）
--------------------------------------------------------------------------------
1) 攻速/冷却：fireRate 初始 2.0s；冷却使用 TimeDelta；fireRate ≥ minFireRate(默认 0.60s 或商店购买后的 0.55)。  
2) 形态乘区：连发 vs 散射 的本次总伤 `totalMultiplier = max(multi_total, scatter_total)`，绝不相乘。  
3) 分裂：isSplitChild=true 的小弹不继承形态技能（连发/散射/穿透/反弹），仅继承数值乘区；主弹分裂 CD=30ms；小弹伤害= 基础60% × 数值乘区。  
4) 穿透/反弹：穿透后伤害 ×0.90（最低50%初伤）；反弹后伤害 ×0.85，并加入 ±4° 随机。  
5) 升级暂停：面板弹出 → isPaused=true 冻结计时器/生成；选中技能后恢复；UI 不穿透/不重影。  
6) 波次：WaveTimer 每 30s 触发；enemySpeed×1.04 / enemyHP×1.06 / spawnRate×0.97（地板 0.30s）。  
7) 泄漏防护：子弹寿命 ≤2s；分裂弹总数 ≤50；同屏敌 ≤80。  
8) 音频：首次交互初始化 AudioContext；前后台切换能恢复 BGM；设置滑条实时生效与持久化。  
9) 数据：SkillState/level/coins/音量/最高分 持久化；旧版存档迁移至当前结构成功。

================================================================================
二、v6 要修复的常见遗留（结合 v5 报告逐条对照）
--------------------------------------------------------------------------------
A. 计时器与暂停竞态
- 确保 fireCooldown、NearestTimer、WaveTimer 在切场景/暂停/教程/Boss 战与恢复后“仅有一份”，并且不会重复启动；增加“守护事件”去重。
- PauseSystem 统一入口：支持“嵌套暂停计数”（面板/教程/Boss 技能/系统失焦分别 +1/-1），避免误恢复或误冻结。

B. 抽卡/满级池/宝箱冲突
- 三选一严格来自“未满级池”，不足 3 项按剩余展示；满级项灰置禁用；
- Boss “紫色宝箱 2选1”与普通升级互斥队列化：若同帧触发，优先宝箱，然后升级；两者均暂停游戏。

C. JSON 读表与 i18n
- `skill_config.json` 缺字段/解析失败 → 回退内置默认；
- i18n 缺失键回退中文；在 QA 面板显示当前语言包覆盖率。

D. 音频与移动端策略
- `pointerdown` 首次交互初始化；tab 切回自动 resume；
- BGM 与大量 SFX 并行时限制并发通道数与全局限幅，避免破音。

E. 对象池与内存
- 子弹/敌人/无人机采用“复用或屏外复位”；一段时间未使用的实例回收；
- QA 面板展示对象池命中率，帮助诊断 GC 尖刺。

F. Healer 精英边界
- 同一帧仅能触发一次群体治疗；单波治疗总量不超过 `capPerWave`；
- 治疗对 Boss 无效；治疗粒子在低性能模式下降级。

================================================================================
三、功能扩展（v6 新增）
--------------------------------------------------------------------------------
A. 每日试炼（Daily Challenge，轻量版）
- 以日期为种子生成“今日规则”：例如 `高密度小怪`/`弱穿透`/`强化反弹` 等 1~2 条；
- 单局开始时显示今日规则；本局排行榜只统计当日规则下成绩（本地）。

B. “卡池加权”与保底
- 记录每个技能的“距上次抽中轮数”；当多轮未出现时适当加权；
- 防止同类技能过度缺席，提高体验；在 QA 面板打印当前加权。

C. 命中反馈与无障碍
- 新增“高对比度模式”与“色盲友好调色”；
- 命中与暴击（若有）使用统一的屏幕震动与可切换的粒子/VFX 强度。

D. 回放与种子输出（轻量）
- 将 RNG 种子、主要操作和关键事件写入一个紧凑日志（内存+可存储）；
- 提供“复制分享码”按钮，可在 QA 面板重放 60s 以复现问题。

E. 控制器支持（可选）
- 兼容手柄的 A/B/X/Y 与 Start/Menu；UI 焦点导航（上下左右 + 触发）。

================================================================================
四、配置与数据（同步到 skill_config.json，如缺则创建或补全）
--------------------------------------------------------------------------------
- 新增 dailyChallenge: { enabled:true, rulesPool:[...], perDaySeed:true }
- 新增 gachaWeights: { base:1.0, pityStep:0.15, pityMax:1.8 }
- 新增 accessibility: { highContrast:false, colorBlind:"off|protan|deutan|tritan" }
- 新增 replay: { enabled:true, windowSec:60, export:true }
- 继续维持 Boss/精英参数（含 Healer）。

================================================================================
五、事件重构要点（必要即可覆盖旧实现）
--------------------------------------------------------------------------------
AutoAim：
- 最近敌 0.05s 更新；ShotPattern 变更时重算 perBulletDamage；
- 子弹实例变量：bullet_damage, penetration_left, rebound_left, isSplitChild=false, lastSplitMs=0；
- 越界/寿命清理；对象池或屏外复位。

SkillSystem：
- showPanel/宝箱队列化；未满级池不放回抽 3；满级灰置；显示 Lv cur/max；
- applySkill：按 v2/v3 公式 + v3 新技能（护盾/无人机/AOE）；
- recalcShotPattern：连发×散射取 max；
- onHit：穿透衰减、分裂小弹生成（不二次分裂）。

WaveSystem / Boss / Elite：
- 波次 30s 提升；每 5 波 Boss；精英按权重附着；Healer 有 CD 与 cap。

Daily / Gacha / Accessibility / Replay（新 External or 合并实现）：
- Daily：根据日期种子应用规则并展示；
- Gacha：计算三选一权重（含保底加权）；
- Accessibility：切换高对比/色盲友好调色（覆盖 UITheme Token）；
- Replay：写入关键事件；支持 60s 重放与“复制分享码”。

QA：
- 新增“对象池命中率”“加权池系数”“每日规则展示”与“回放复现”按钮。

================================================================================
六、性能优化（v6）
--------------------------------------------------------------------------------
- FPS P50/P95 监控 + 自动低性能模式（P95<50 启用，P95≥55 回退）。
- 敌人大规模生成与 Boss 弹幕分帧/批量 API；
- 粒子/拖尾在低性能时下降到 50%；VFX 限频与合并。

================================================================================
七、自动断言（必须全部 PASS）
--------------------------------------------------------------------------------
- 攻速下限（0.60s / 或商店 0.55s）；
- 连发+散射使用 max()；
- 分裂子弹不再分裂且不继承形态技能；
- 穿透/反弹衰减生效；
- 波次/生成速递增 + 地板/上限正确；
- 旧存档成功迁移（列出迁移数量/失败原因）；
- Boss 每 5 波触发且掉落宝箱；Healer 有 CD 与 cap；
- 对象池命中率≥70%（示例阈值，可在低性能模式下放宽）；
- 每日试炼的规则正确应用并在 HUD 标记；
- 回放 60s 的重放与分享码一致；
- 抽卡保底权重在 QA 中有打印，且不会导致超出 `maxLevel` 的条目被抽中。

================================================================================
八、输出（每轮必须打印）
--------------------------------------------------------------------------------
1) 变更清单：新增/修改/覆盖的场景、对象、External、变量与关键事件；
2) 自测报告：
   - QA：Spawn50 / LevelUpTo10 / SpreadTest / 压力测试 / 触摸连点 / RNG 重放 / 对象池命中率 / 每日规则 的 avg FPS / p95 FPS / 指标；
   - 存档迁移结果（成功/失败与原因）；
   - 从 V5_UPGRADE_REPORT.md 抽取的“已修复/未修复/新发现”对照表；
3) 若仍有 TODO → 列出并在下一轮自动完成。

================================================================================
九、CHANGELOG & 版本自动化（若存在则启用）
--------------------------------------------------------------------------------
- 若仓库根存在 CHANGELOG.template.md 与 Codex_Changelog_AutoPrompt.txt，执行完自动更新 CHANGELOG.md 与 VERSION，并以 Conventional Commits 写提交。

（完）
