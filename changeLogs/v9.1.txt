GDevelop + Windsurf Codex — v9.1 升级提示
===============================================================================
仓库：https://github.com/eat-chestnut/game
前置：已完成 v9（装备升级/合成、宝石、五行元素与克制±30%）。
本轮目标：在不破坏既有“硬约束”和数值平衡的前提下，**修复 v9 遗留问题并新增**：
1) **技能特效与元素状态扩展（Burn/Freeze/Root/Shatter/Expose 等）**
2) **技能之间的组合技（多流派）**
3) **元素状态互斥/联动规则**（如：灼烧下不可冰冻；冰冻被火击中会解冻且伤害降低；高伤火可引发二次“炸裂”）
4) **通用宝石**（任何部位可用；每件装备最多可镶嵌 **6 个** 宝石，随稀有度&等级开放）
5) **高阶装备对技能效果的加成**（仅加成“技能特效参数”，不突破全球硬约束）

实现与本提示冲突时，**直接重构覆盖**；禁止人工确认。

===============================================================================
【自适应输入（务必首先执行）】
-------------------------------------------------------------------------------
1) 读取并解析根目录（按优先级）：
   - `V6_V6.1_UPGRADE_REPORT.md`、`V7_UPGRADE_REPORT.md`、`V8_UPGRADE_REPORT.md`、`V9_UPGRADE_REPORT.md`（如存在）
   - `CHANGELOG.md`（读取 `Unreleased` 与最近两版段落）
   - `skill_config.json`、`equipment_config.json`、（若有）`docs/equipment_sets.md`
2) 根据报告与现状生成“v9→v9.1 待改清单”，分为 Bugs/Regression、Polish/UX、Perf/Memory、New Features。
3) 逐项落地；报告未提及但代码中可复现的问题，也要补充修复。

===============================================================================
一、既有硬约束（回归体检，必须继续正确）
-------------------------------------------------------------------------------
- 攻速/冷却：`fireRate` 初始 2.0s；使用 TimeDelta 递减；`fireRate ≥ max(minFireRate, capFireRate)`（默认≥0.60s；商店/装备到 0.55，不再低）。
- 形态乘区：连发 vs 散射 → `totalMultiplier = max(multi_total, scatter_total)`；**不相乘**；单弹伤害等比分配。
- 分裂：`isSplitChild=true` 不继承形态技能；仅承接数值乘区；主弹分裂 CD=30ms；小弹基础伤害= 60% × 数值乘区（装备 `splitChildPct` 额外加成≤+30%）。
- 穿透/反弹：穿透后×0.90（最低 50% 初伤）；反弹后×0.85（±4° 随机）。
- 元素克制：默认环 **木→土→水→火→金→木**；单层修正∈{0.70,1.00,1.30}；多属性取|±30%|较大项。
- 性能保护：子弹寿命≤2s；同屏分裂弹≤50；同屏敌≤80。
- 暂停/面板：升级与宝箱**队列化**（宝箱优先），面板展示时 `isPaused=true`。

===============================================================================
二、v9→v9.1 需修复/打磨（结合报告逐条对照）
-------------------------------------------------------------------------------
A. 融合缓存与 Loadouts
- 切换预设时走**差量更新**；HUD 延迟≤1帧；避免整表重算卡顿。
- 融合顺序维持：基础→技能/商店→装备/等级→套装→宝石→元素→**状态修正**→clamp→形态（max）。

B. 宝石/合成/升级鲁棒性
- 库存并发修改与“重复点击”保护；碎片余额防负；批量拆卸尊重锁定；
- **上限调整**：每件装备允许 **最多 6 个宝石**；按稀有度与 `level` 动态解锁：
  - Common：2，Rare：3，Epic：4，Legend：5；Lv≥8 的 Legend 可解锁到 **6**。
- `equipment_config.json` 中的 `sockets` 作为**下限**，实际可上浮到上表上限。

C. i18n/可访问性
- 所有新增状态/组合技/宝石 UI 有中英文本；缺键回退中文；高对比/色盲主题覆盖新增图标。

D. 计时器与引用计数型暂停
- `fireCooldown/NearestTimer/WaveTimer/BossSkillTimer/DailyTimer/StatusTimer` 唯一实例；守护去重。

===============================================================================
三、元素状态系统（新增“技能特效与元素状态”）
-------------------------------------------------------------------------------
【状态表（首版轻量实现，可后续深化）】
- **Burn(灼烧/Fire)**：持续伤害 DoT（每 0.5s 触发一次，默认 2s，总伤≈子弹伤×0.4，随“技能/装备加成”线性提升；对 Boss 有 0.6×修正）。
- **Freeze(冰冻/Water)**：冻结 1.25s（对 Boss 仅减速 40%，持续 0.8s）；冻结时受到火伤会**解冻**且当次火伤 **-20%**（见状态交互）。
- **Root(缠绕/Wood)**：定身 1.0s（Boss 则减速 60%，1.0s）；
- **Shatter(碎裂/Earth)**：对带有“硬直/冻结/定身”目标的下一次命中，**+15%**（仅消耗一次，不叠层）。
- **Expose(破甲/Metal)**：降低子弹抗性，受击后 **子弹类伤害 +12%**，持续 4s（Boss 6s 上限 1 层）。

【状态参数来源】
- 基础值写入 `skill_config.json` 的新增节点 `statusDefaults`；
- “高阶装备对技能效果加成”通过装备词缀/套装/宝石写入 `statusScale`（如 DoT 倍率、持续时长%、易伤%、减速% 上限等）。
- **全局硬约束**：任何状态影响都不得突破已定义的“攻速下限/乘区上限/穿透&反弹上限”的硬边界；冻结对 Boss 不完全生效。

===============================================================================
四、状态交互与组合技（多流派）
-------------------------------------------------------------------------------
【互斥/联动规则（必须实现）】
1) **灼烧 ↔ 冰冻**：目标带有 Burn 时**不能**被 Freeze；若目标处于 Freeze，被 Fire 命中：
   - 立刻**解冻**；该次火伤 **-20%**；
   - 若该次火伤的“元素伤害阈值”≥`explodeThreshold`（从 `skill_config.statusDefaults.fire.explodeThreshold` 读取），触发**二次伤害“炸裂”**（小范围 AOE，等同该次伤害×0.35，Boss×0.2）。
2) **Root + Shatter**：被 Root 的目标受到 Earth 元素命中时，优先消耗 Shatter 的一次性增伤（若存在）。
3) **Expose 叠加限制**：Expose 不叠层，仅刷新持续时间；对 Boss 持续时间×1.5，但数值不变。

【组合技（示例，可配置化）】
- **水→火（解冻炸裂）**：见上（高伤阈值触发）。
- **木→土（定身→碎裂）**：Root 提供控制窗口，Earth 子弹享受 Shatter 的一次性增伤。
- **金→火（破甲→灼烧）**：先上 Expose，再上 Burn，可提升 Burn 每跳 DoT 伤害（通过 `statusScale` 与 `statusDefaults` 结合实现上限内加成）。

配置：在 `skill_config.json` 新增 `comboRules`，声明触发顺序与数值上限，允许后续扩展。

===============================================================================
五、宝石系统升级（通用宝石 & 6 槽上限）
-------------------------------------------------------------------------------
- 新增 **Universal（通用）** 宝石类型（如 `Quartz`/“白晶”）：可在**任何槽位**镶嵌；提供轻量型“状态强化”词缀（例：`statusDotPct:+3%` / `statusDurationPct:+4%` / `statusVulnPct:+2%`）。
- 每件装备可镶嵌宝石的**理论上限=6**；实际开放数量由稀有度+等级决定（见 二-B）；
- UI：
  - 背包卡面显示“6 格阴影”，已解锁的格子高亮，可用/不可用状态一目了然；
  - 批量拆卸/批量镶嵌支持“只操作已解锁槽位”；
  - 通用宝石与元素宝石在筛选器中独立维度。

===============================================================================
六、高阶装备对技能效果加成
-------------------------------------------------------------------------------
- 在 `equipment_config.json` 新增或扩展 `affixes.statusScale` 类目：
  - 示例键：`statusDotPct`（DoT 伤害%）、`statusDurationPct`（状态时长%）、`statusVulnPct`（易伤%上限内）、`statusSlowCapPct`（减速上限%）、`statusExplodePowerPct`（解冻炸裂倍率%）。
  - 仅影响**状态系统参数**；**不影响**硬约束（攻速、乘区、穿透、反弹等）。
- 套装（sets）可追加与状态相关的小加成（如 Hunter set4 额外 `statusDotPct:+5%`）。

===============================================================================
七、数据结构与迁移
-------------------------------------------------------------------------------
- `skill_config.json`：追加 `statusDefaults` 与 `comboRules`；若缺则创建默认；
- `equipment_config.json`：
  - 扩展 `ui`：加入 `maxSocketsPerItem: 6`；
  - 若缺 `affixes.statusScale*` 词缀项则追加；
  - `sockets` 作为下限，按稀有度/等级提升实际开放上限；
- 存档：
  - 已有装备补写 `unlockedSocketCount`（按稀有度/等级推导）；
  - 新增 `statusSettings`（是否显示元素浮字/强提示）与 `inputBindings` 扩展（状态页快捷键）；
  - 版本号 +1，迁移统计打印。

===============================================================================
八、事件与实现要点（按需覆盖旧实现）
-------------------------------------------------------------------------------
- **StatusSystem（新 External）**：
  - 为敌人维护状态组件：`hasBurn/Freeze/Root/Shatter/Expose` + `duration/stack/lastTick`；
  - 每帧/定时 tick 计算 DoT/减速/易伤；与 Boss 规则分支；
  - 实现“解冻逻辑”与“火元素高伤触发炸裂”。
- **ComboEngine（新 External）**：
  - 读取 `comboRules`，在命中时判断“先后手”与触发条件，写入滚动窗口事件；
  - 与 StatusSystem 解耦，使用事件总线或变量桥接。
- **GemSystem 升级**：
  - 统一管理“解锁槽位”数量、通用宝石判定、批量操作与筛选；
  - 安全检查：锁定宝石/装备不参与批量拆装。
- **Fusion Cache**：
  - 在“元素修正”之后衔接“状态修正乘区”（例如 Expose 的 +% 易伤）；
  - clamp 后再走连发/散射形态。

===============================================================================
九、QA 与自动断言（必须全部 PASS）
-------------------------------------------------------------------------------
- **硬约束**：攻速下限、连发×散射取 max、分裂不再分裂、穿透/反弹衰减、装备乘区≤30%、穿透≤3、反弹≤2、分裂小弹额外加成≤+30%。
- **状态**：
  - Burn 每 0.5s 跳伤；总伤占比与配置一致（Boss ×0.6）；
  - Freeze 对小怪完全冻结；对 Boss 降速 40%；被火命中触发解冻与 -20% 火伤；
  - Shatter 仅触发一次并正确消耗；Expose 不叠层仅刷新；
  - Root/Freeze 与 Shatter 的顺序互斥逻辑正确。
- **组合技**：
  - 水→火的“解冻炸裂”在高伤阈值时触发，AOE 倍率正确；
  - 木→土 的增伤只消耗一次；金→火 可提高 Burn 跳伤（不超上限）。
- **宝石**：
  - 每件装备最多 6 槽；解锁数随稀有度&等级上升；批量拆卸/镶嵌只作用已解锁槽；
  - 通用宝石在任意槽可用；筛选正确。
- **装备状态加成**：
  - `statusScale*` 仅影响状态参数；不会突破硬约束；
  - 套装对状态的加成与装备词缀叠加顺序稳定（先装备，再套装，最后 clamp）。
- **性能**：
  - 500 敌人目标下，开启 Burn/Freeze/Expose 的 DoT/减速/易伤计算，**P95 ≥ 50FPS**（低性能模式≥45）。
- **存档迁移**：
  - 新增字段写入成功；兼容旧档；打印迁移成功/失败条数与示例。

QA 面板新增：
- “状态矩阵回归”：输出五行×状态×Boss/小怪的效果表与耗时；
- “组合技回归”：水→火炸裂、木→土碎裂、金→火灼烧增伤的触发统计；
- “宝石 6 槽压力”：满载切换 Loadouts + 批量拆装的帧时分布；
- “状态参数可视化”：实时显示 DoT/易伤/减速/冻结剩余时间。

===============================================================================
十、输出与自动化
-------------------------------------------------------------------------------
- 每轮输出：
  1) 变更清单（新增/修改/覆盖的场景、对象、External、变量与配置）；
  2) 自测报告：各 QA 用例的 avg / p95 FPS 与断言结果；存档迁移统计；与升级报告映射完成度；
  3) 若仍有 TODO → 列出并在下一轮自动完成。
- 若仓库存在 `CHANGELOG.template.md` 与 `Codex_Changelog_AutoPrompt.txt`：自动更新 `CHANGELOG.md` 与 `VERSION` 并以 Conventional Commits 提交。

（完）
