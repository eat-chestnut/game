GDevelop + Windsurf Codex — v9.2 升级提示（自适应审计 v9 / v9.1，回归修复 + 打磨优化）
================================================================================
仓库：https://github.com/eat-chestnut/game
前置：已完成功能至 v9.1（装备升级/合成、通用宝石与 6 槽、五行克制±30%、元素状态与组合技等）。
目标：在不破坏硬约束的前提下，**回归体检 v9 / v9.1 的实现**，修复潜在 bug，提升性能与体验，并补充必要的开发者工具与断言。
如现实现与本提示冲突，**直接重构覆盖**；全程无需人工点击。

【自适应输入（必须首先执行）】
1) 读取并解析以下文件（按优先级）：
   - `V9_UPGRADE_REPORT.md`, `V9_FULL_UPGRADE_REPORT.md`, `V9.1_UPGRADE_REPORT.md`（如存在）
   - `CHANGELOG.md`（读取 `Unreleased` 与最近两版段落）
   - `equipment_config.json`, `skill_config.json`, `docs/equipment_sets.md`
   - （若存在）`five_elements_patch.json`, `enemy_elements_patch.json`, `element_matrix.json`
2) 汇总“v9/v9.1 → v9.2 待改清单”，分为：Bugs/Regression、Polish/UX、Perf/Memory、Data/Config、QA/DevTools。
3) 逐项落地；报告未提及但代码中可复现的问题，也要补充修复（请在自测报告中标注“新发现”）。

================================================================================
一、硬约束（必须继续成立）
--------------------------------------------------------------------------------
- 攻速下限：`fireRate ≥ max(minFireRate, capFireRate)`（默认≥0.60s；商店/装备可至 0.55，不再低）。
- 形态乘区：连发 vs 散射 → `totalMultiplier = max(multi_total, scatter_total)`（**不相乘**，单弹等比分配）。
- 分裂：`isSplitChild=true` 不继承形态技能；主弹分裂 CD=30ms；小弹基础伤害= 60% × 数值乘区（装备额外加成≤+30%）。
- 穿透/反弹：穿透后×0.90（≥50%初伤），反弹后×0.85（±4°）。
- 元素克制：五行环（木→土→水→火→金→木）；单层修正∈{0.70,1.00,1.30}；多属性取 |±30%| 的最大值。
- 泄漏保护：子弹寿命≤2s；同屏分裂弹≤50；同屏敌≤80。
- 面板/暂停：升级与宝箱**队列化**（宝箱优先）；面板出现时 `isPaused=true`。

================================================================================
二、v9 / v9.1 常见缺陷与本次修复
--------------------------------------------------------------------------------
A. 状态系统鲁棒性（Burn/Freeze/Root/Shatter/Expose）
- 修复“冻结残留”与“重复施加”并发：使用状态组件的 `applyAt`/`expireAt` 时间戳与去抖。
- DoT 计时：统一 0.5s tick；使用 TimeDelta 累积误差不超过 10ms；Boss DoT 系数×0.6 生效。
- 解冻逻辑：火击中冻结 → 立刻移除 Freeze、本次火伤 -20%、若 `damage >= explodeThreshold` 则触发 AOE（半径与倍率可配置，Boss 额外×0.8）。
- Shatter：仅消费一次；与 Root/Freeze 的触发优先级按 `comboRules`。

B. 组合技与权重
- `comboRules` 落地：水→火“解冻炸裂”，木→土“碎裂加成”，金→火“灼烧增伤上限内加成”；
- 组合技冷却与去重：对同目标 0.3s 内只触发一次同类组合。

C. 宝石系统（通用宝石 + 6 槽）
- 槽位解锁：按（稀有度, level）推导 `unlockedSocketCount`；`ui.maxSocketsPerItem=6` 为上限，`sockets` 为下限；
- 批量操作安全：锁定宝石/装备不参与；余额不为负；重复点击防抖。

D. 装备升级/合成
- 合成优先级：同槽同稀有→先+level，溢出再给“小阶品质”权重；合成/升级产生的数值仍受 clamp；
- UI：等级徽章与消耗预览一致；

E. 计时器与引用计数型暂停
- `fireCooldown/NearestTimer/WaveTimer/BossSkillTimer/DailyTimer/StatusTimer` 唯一实例；场景切换/失焦恢复后不重复启动；
- Pause counter：面板/教程/Boss/失焦各自 +1/-1，任何计数>0 则冻结生成与计时器。

F. i18n 与可访问性
- 新增文案的中英双语键；缺键回退中文；高对比/色盲主题覆盖状态/组合技/宝石 UI。

================================================================================
三、性能优化（v9.2）
--------------------------------------------------------------------------------
- 状态与组合技计算分帧；DoT 批处理；HUD 浮字限频；
- 背包与宝石面板采用虚拟滚动；
- 融合缓存仅在输入变化时重算（技能/装备/宝石/套装/元素/状态设置）；Loadouts 切换走差量；
- 对象池命中率≥70%（低性能模式≥60%）；粒子/光柱在低性能模式降级。

================================================================================
四、配置与数据
--------------------------------------------------------------------------------
- `skill_config.json`：校验并补全 `statusDefaults`、`comboRules`；
- `equipment_config.json`：若缺 `ui.maxSocketsPerItem` 则补 6；若缺 `affixes.statusScale*` 追加默认；
- 五行补丁：若仓库存在 `five_elements_patch.json` / `enemy_elements_patch.json` / `element_matrix.json`，在加载时合并，缺失则跳过并打印提示。
- 存档迁移：为旧装备补写 `unlockedSocketCount`、新状态设置字段；版本号 +1。

================================================================================
五、事件与代码要点（按需覆盖旧实现）
--------------------------------------------------------------------------------
- StatusSystem：基于组件的多状态机；freeze/burn/root/expose/shatter 的帧更新；与 Boss 修正规则分支；
- ComboEngine：命中时读取 `comboRules`，判断先后与冷却；派发“二次伤害/加成事件”；
- GemSystem：统一管理解锁槽位与通用宝石；批量拆装与筛选；
- Fusion Cache：顺序为 基础→技能/商店→装备/等级→套装→宝石→元素→**状态修正**→clamp→形态(max)；
- PauseSystem/TimerGuard：守护去重，引用计数型暂停。

================================================================================
六、QA 按钮与自动断言（必须 PASS）
--------------------------------------------------------------------------------
- 硬约束：攻速 floor、连发×散射取 max、分裂不再分裂、穿透/反弹衰减与 clamp、装备乘区≤30%、穿透≤3、反弹≤2、分裂小弹加成≤+30%。
- 状态：Burn/Freeze/Root/Expose/Shatter 的持续/上限/解冻逻辑/一次性消耗正确；Boss 分支正确；
- 组合技：水→火炸裂（阈值&倍率）、木→土碎裂（一次性）、金→火灼烧增伤（不越界）；组合冷却 0.3s 生效；
- 宝石：每件最多 6 槽；解锁数按（稀有度, 等级）提升；批量操作尊重锁定；
- 合成/升级：数值增长与消耗一致；重复点击不重算；
- 性能：500 敌目标，状态/组合技活跃，**P95 ≥ 50FPS**（低性能≥45）；
- 迁移：新增字段写入成功；打印成功/失败计数与示例。

================================================================================
七、输出（每轮必须打印）
--------------------------------------------------------------------------------
1) 变更清单：新增/修改/覆盖的场景、对象、External、变量与配置；
2) 自测报告：avg/p95 FPS、断言结果、迁移统计、从报告映射的完成度（Bugs/Polish/Perf/Data/DevTools）；
3) 若仍有 TODO → 列出并在下一轮自动完成。

================================================================================
八、CHANGELOG & 版本自动化（若存在则启用）
--------------------------------------------------------------------------------
- 若根目录存在 `CHANGELOG.template.md` 与 `Codex_Changelog_AutoPrompt.txt`：执行完自动更新 `CHANGELOG.md` 与 `VERSION`，并以 Conventional Commits 提交。

（完）
