GDevelop + Windsurf Codex — v4 升级提示（在现有版本上自动执行）
================================================================================
目标：在 https://github.com/eat-chestnut/game 的当前版本基础上，进行全面体检（含 v2 与 v3 的回归）、修复潜在 bug、补齐缺失特性，并继续功能与性能优化。
若实现与本提示不符，直接重构覆盖。兼容当前目录结构（libs/, src/, index.html, build.config.json, skill_config.json）。

【执行模式】
- 全自动：创建/修改/覆盖 场景、对象、事件、变量、资源；不得要求人工点击。
- 每轮输出“变更清单 + 自测报告”；若仍有 TODO，下一轮自动完成。
- 若现有实现与本提示冲突，以本提示为准进行重构覆盖。

----------------------------------------------------------------
一、回归体检（确保 v2/v3 的硬约束仍成立）
----------------------------------------------------------------
1) 冷却/攻速：fireRate 初始 2.0s；fireCooldown 使用 TimeDelta 递减；fireRate ≥ minFireRate(0.60s)。
2) 形态乘区：连发 multi 与散射 scatter 的本次总伤 totalMultiplier = max(multi_total, scatter_total)，不相乘。
3) 分裂小弹：isSplitChild=true 不继承形态技能（连发/散射/穿透/反弹），仅继承数值乘区；每主弹分裂 CD=30ms；小弹伤害= 基础60% × 数值乘区。
4) 穿透/反弹：穿透衰减 ×0.90（最低50%）；反弹衰减 ×0.85（随机偏移±4°）生效。
5) 升级暂停：面板弹出时 isPaused=true 冻结计时器/生成；选择后恢复；UI 不穿透、不重影。
6) 波次计时：计时器“WaveTimer”每 30s 触发；enemySpeed×1.04、enemyHP×1.06、spawnRate×0.97（地板0.30s），Toast 提示。
7) 泄漏防护：子弹寿命 ≤2s；分裂弹总数 ≤50；同屏敌人数 ≤80。
8) 读表兼容：skill_config.json 字段名若与实现不一致，要有适配层并打印兼容日志（一次性）。

----------------------------------------------------------------
二、v3 实装常见隐患与本次修复
----------------------------------------------------------------
- 暂停竞态：统一通过 PauseSystem 读写 isPaused；修正“切场景 / 触发弹窗 / 浏览器失焦恢复”导致的计时器半挂起。
- 计时器重复启用：Skill 面板关闭、场景切换后，确保 fireCooldown / NearestTimer / WaveTimer 仅有一份；加入“去重守护”事件。
- 抽卡唯一性：三选一严格从“未满级池”不放回抽取；若不足 3 项则按剩余展示；满级项灰置并禁用。
- 存档迁移：将 SkillState/level/coins/音量/最高分 持久化；提供 v2→v3→v4 的版本迁移脚本（缺字段回填默认值并标记迁移成功）。
- 音频策略：首次交互初始化 AudioContext；前后台切换后自动恢复 BGM；设置滑条实时生效并持久化。
- 触摸可用性：按钮命中区 ≥44px；关键按钮加 200ms 防抖；移动端长按可选“暂停/继续”。
- 超宽/超高屏适配：针对 ≤360 宽或 ≥21:9 的比例，HUD 边距在 8/12/16px 间自适应。
- JSON 容错：skill_config.json 解析失败或缺字段 → 自动回退到内置配置并继续运行，同时输出非阻塞错误。

----------------------------------------------------------------
三、v4 新功能
----------------------------------------------------------------
A. Boss 波次与精英词缀
- Boss：每 5 波出现一次 Boss（高 HP、缓慢、可释放环形弹幕）；受 AOE 额外衰减 ×0.75。
- 精英词缀：Fast(速度+25%)、Thick(HP+30%)、Splitter(死亡分裂两只小怪)、Resistant(受到子弹伤害 -20%)。
- HUD 在 Boss 波显示血条与阶段提示；击杀授予额外金币/经验并保证掉落。

B. 教程/新手引导（非阻塞）
- 首次运行弹出四步引导（点击继续）：自动射击说明、升级与抽卡、Buff 提示、暂停/设置。
- 引导完成状态持久化；可在设置中重置。

C. 数值观测与调参面板（开发者开关）
- QA 面板新增“数值观察”页：实时显示 fireRate / bulletDamageMultiplier / shotCount / totalMultiplier / splitCount / penetration&rebound 层数分布。
- 支持固定随机种子（RNG seed）重放以稳定复现问题。

D. 掉落与商店（基础版）
- coins 随击杀+1；MainMenu 开启商店（占位 UI）：
  - BulletDamage：+8% 乘区
  - FireRateCap：将 minFireRate 从 0.60 提至 0.55（仅一次）
  - LootChance：+3%（上限 30%）
- 商店数值只对新开局生效（防止中途切换破坏平衡），并持久化。

----------------------------------------------------------------
四、配置与数据更新
----------------------------------------------------------------
- 将 v3 的 skill_config.json 与实现对齐并追加（若缺失则创建）：
  - Boss/精英参数表（HP/速度/掉落保底/词缀权重）。
  - settings.lowPerfMode（粒子/拖尾数量下调到 50%）。
  - i18n 简易字典：中文/英文的技能名与描述映射，用于 UI。
- 读表失败时，自动写入内置默认配置并提示兼容层已启用。

----------------------------------------------------------------
五、事件与代码重构要点
----------------------------------------------------------------
AutoAim：
- 仅在 ShotPattern 变更时重算“每颗伤害”；
- 最近目标用计时器 0.05s 更新（平方距离）；
- 发射时写入：bullet_damage / penetration_left / rebound_left / isSplitChild=false / lastSplitMs=0；
- 子弹越界或寿命>2s 清理。

SkillSystem：
- showPanel：未满级池不放回抽 3；满级灰置；显示 Lv cur/max；
- applySkill：按 v2/v3 公式 + v3 新技能（护盾/无人机/AOE）更新；
- recalcShotPattern：连发×散射取 max；
- onHit：穿透衰减、分裂小弹生成（不二次分裂）。

Boss/Elite（新 External）：
- Boss 生成、阶段切换（<70% / <40% HP 时释放技能），Boss 死亡保底掉落；
- 精英词缀修饰敌人属性与 UI 标识（图标或描边）。

WaveSystem / LootDrop / PauseSystem / Audio / QA：
- 修复计时器与暂停互操作；
- QA 新增“压力测试 3× 波次”与“移动端触摸连点测试”；
- AudioContext 初始化/恢复；设置页实时调节与存档。

----------------------------------------------------------------
六、性能优化（v4）
----------------------------------------------------------------
- 对象池：子弹/敌人/无人机优先复用（或屏幕外复位），减少 GC。
- 分位数监控：QA 显示 FPS 的 P50/P95；当 P95 < 50 FPS 时自动开启 lowPerfMode 并提示。
- 批量创建：生成敌人/弹幕时延迟分帧创建，避免尖刺。
- 震屏限幅：统一限幅与冷却，避免连锁卡顿。

----------------------------------------------------------------
七、自动断言（必须全部 PASS）
----------------------------------------------------------------
- fireRate ≥ 0.60s（或购买 FireRateCap 后的新下限），任意升级路径不突破。
- 连发+散射使用 max()，不相乘。
- 分裂子弹不再分裂且不继承形态技能。
- 穿透/反弹衰减生效并遵循边界。
- 波次/生成速递增与地板/上限逻辑正确。
- v2/v3 存档成功迁移到 v4（字段映射与默认值回填）。
- Boss 波按每 5 波触发；Boss 死亡掉落保底。
- 低性能模式能根据 P95 FPS 自动切换并回退。

----------------------------------------------------------------
八、输出要求（每轮必须打印）
----------------------------------------------------------------
1) 变更清单：新增/修改/覆盖的场景、对象、External、变量与关键事件。
2) 自测报告：
   - QA：Spawn50/LevelUpTo10/SpreadTest/压力测试/触摸连点 的 avg FPS / p95 FPS / min fireRate / totalMultiplier；
   - 存档迁移结果（成功/失败与原因）。
3) 若仍有 TODO → 列出并在下一轮自动完成。

----------------------------------------------------------------
九、CHANGELOG & 版本自动化（若存在则启用）
----------------------------------------------------------------
- 如果仓库中存在 CHANGELOG.template.md 与 Codex_Changelog_AutoPrompt.txt，执行完毕后自动更新 CHANGELOG.md 与 VERSION，并以 Conventional Commits 写提交信息。

----------------------------------------------------------------
十、参考（仓库概览）
----------------------------------------------------------------
- 目录项：libs/, src/, index.html, build.config.json, skill_config.json

（完）
