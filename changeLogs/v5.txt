GDevelop + Windsurf Codex — v5 升级提示（在当前版本基础上自动执行）
================================================================================
仓库：https://github.com/eat-chestnut/game
目标：在现有版本（已包含 v2/v3/v4 能力）上，自动体检、修复新增缺陷、补齐实现，并继续功能&性能优化。
若现有实现与本提示冲突，请直接重构覆盖；全程不得要求人工点击。

【统一执行模式】
- 全自动创建/修改/覆盖 场景、对象、External Events、资源与变量；
- 每轮输出：变更清单 + 自测报告（含 FPS 分位与断言结果）；若仍有 TODO，下一轮自动完成；
- 若检测到 skill_config.json 或存档结构与实现不一致，启用“适配层 + 迁移脚本”，并打印一次性兼容日志。

================================================================================
一、回归体检（必须保持正确的既有特性）
--------------------------------------------------------------------------------
1) 攻速/冷却：fireRate 初始 2.0s；冷却使用 TimeDelta；fireRate ≥ minFireRate(默认 0.60s 或商店购买后的 0.55)。  
2) 形态乘区：连发 vs 散射 的本次总伤 `totalMultiplier = max(multi_total, scatter_total)`，绝不相乘。  
3) 分裂：isSplitChild=true 的小弹不继承形态技能（连发/散射/穿透/反弹），仅继承数值乘区；主弹分裂 CD=30ms；小弹伤害= 基础60% × 数值乘区。  
4) 穿透/反弹：穿透后伤害 ×0.90（最低50%初伤）；反弹后伤害 ×0.85，并加入 ±4° 随机。  
5) 升级暂停：面板弹出 → isPaused=true 冻结计时器/生成；选中技能后恢复；UI 不穿透/不重影。  
6) 波次：WaveTimer 每 30s 触发；enemySpeed×1.04 / enemyHP×1.06 / spawnRate×0.97（地板 0.30s）。  
7) 泄漏防护：子弹寿命 ≤2s；分裂弹总数 ≤50；同屏敌 ≤80。  
8) 音频：首次交互初始化 AudioContext；前后台切换能恢复 BGM；设置滑条实时生效与持久化。  
9) 数据：SkillState/level/coins/音量/最高分 持久化；旧版存档迁移至当前结构成功。

================================================================================
二、v4→v5 Bug 修复与鲁棒性
--------------------------------------------------------------------------------
A. 计时器与暂停竞态
- 修复：场景切换/失焦恢复后，fireCooldown、NearestTimer、WaveTimer 仅有一份；增加“守护事件”自动去重。
- 修复：Boss 波暂停/教程暂停 与 升级面板暂停互斥问题；统一通过 PauseSystem 控制。

B. 技能抽卡/满级池
- 保障三选一为“未满级池不放回抽取”；不足 3 项按剩余项显示；满级项灰置禁用，且不再影响概率。

C. JSON 读表的异常
- skill_config.json 缺字段/解析失败 → 自动回退到内置默认，并提示“兼容层启用(once)”。
- 追加 i18n 字典兼容：若缺语言键，用中文回退。

D. 音频策略在移动端
- 统一 `pointerdown` 首次交互后初始化音频；tab 切回后自动 resume；
- 防止某些浏览器因为自动播放策略导致 BGM 偶发静音。

E. UI 适配与可访问性
- 所有交互控件命中区 ≥44px；对触摸长按增加 200ms 防抖；
- HUD 在 ≤360 宽、≥21:9 时切换到紧凑布局（8/12/16 px 边距层级）。

================================================================================
三、功能扩展（v5 新增）
--------------------------------------------------------------------------------
A. Boss/精英系统完善
- Boss 阶段技能新增“扇形弹幕”与“冲锋”：<70%时环形弹幕，<40%时扇形+冲锋（有前摇与影子提示）；
- Boss 血条增加阶段分隔；死亡保底掉落“紫色宝箱”（给出 2 个随机技能备选，仅能选 1 个，不计入普通升级次数）。
- 精英词缀新加入：`Healer`（周期性为附近小怪恢复少量 HP，有冷却与上限）。

B. 无人机与护盾增强（源自 v3）
- `summon_drone`：允许在 QA 面板中切换“自动瞄准最近敌/固定环绕射击”两种 AI；无人机子弹寿命 ≤1.2s。
- `defense_shield`：被击穿 0.5s 内给予“短暂无敌帧”（仅对子弹），避免被多弹同帧秒杀。

C. 商店与经济
- 商店新增 `StartCoin+`（开局金币 +5/+10，cap=+20）；`DroneAI+`（解锁无人机 AI 切换）。
- 防刷：本局金币只在结算结转；中途退出不结转。

D. 教程/新手引导补强
- 教程步骤增加：展示“技能卡 Lv 与上限、满级禁用”的截图提示；支持“跳过教程”并持久化。

E. QA 与开发辅助
- 新增“RNG 种子重放”按钮：固定随机种子运行 60s，重复 3 次，输出 avg/p95 FPS 与击杀统计；
- 数值观察页增加“perBulletDamage 分布直方图（文本桶）”。

================================================================================
四、配置与数据（同步到 skill_config.json，如缺则创建或补全）
--------------------------------------------------------------------------------
- 为 Boss/精英扩展加入参数：
  boss: { phaseThresholds: [0.7, 0.4], chestDrop: "purple", chestChoice: 2 }
  eliteAffixes: { Fast:{speedMul:1.25}, Thick:{hpMul:1.3}, Splitter:{split:2}, Resistant:{bulletDmgScale:0.8}, Healer:{radius:160, heal:8, cd:5, capPerWave:3} }
- settings: { lowPerfMode:true/false, rngSeed:0|null, hitVFX:"particles|none" }
- i18n: 确保所有新增文案具备 zh/en 两套映射；缺失时中文回退。

================================================================================
五、事件重构要点（必要即可覆盖旧实现）
--------------------------------------------------------------------------------
AutoAim：
- 最近敌人更新频率 0.05s；发射时按 ShotPattern 生成子弹；只在 ShotPattern 变化时重算 perBulletDamage；
- 子弹实例变量：bullet_damage, penetration_left, rebound_left, isSplitChild=false, lastSplitMs=0；
- 寿命/越界清理；对象池或屏外复位以减少 GC。

SkillSystem：
- showPanel：未满级池不放回抽 3；满级灰置；显示 Lv cur/max；
- applySkill：按 v2/v3 公式 + v3（护盾/无人机/AOE）的规则；
- recalcShotPattern：连发×散射取 max；统一计算 totalMultiplier 与每颗伤害分配；
- onHit：穿透衰减与分裂生成；禁止小弹再次分裂；
- Boss 宝箱：击杀 Boss 时弹出 2 选 1 面板（从当前技能池随机，排除满级）。

WaveSystem / Boss / Elite：
- 波次每 30s 提升；每 5 波生成 Boss；精英词缀按权重附着；
- Healer 精英在 cd 内对周围小怪 heal，单波上限 capPerWave；UI 标识词缀图标。

LootDrop / Shop：
- 能量球 Buff（攻速 25%，8s）；
- Shop 增：StartCoin+、DroneAI+；仅对新开局生效；持久化。

PauseSystem / Audio / QA：
- PauseSystem 统一控制 isPaused；
- Audio 恢复/初始化策略统一；
- QA 新增 RNG 重放与直方图统计；压力测试 3× 波次。

================================================================================
六、性能优化（v5）
--------------------------------------------------------------------------------
- 统计 FPS 的 P50/P95；当 P95 < 50 FPS 时自动开启 lowPerfMode（特效/粒子/拖尾下降到 50%），并在恢复到 P95≥55 时自动回退；
- Boss 弹幕采用分帧批量创建；
- 震屏与 VFX 统一限频；
- 资源按需加载（延迟首次生成相关对象时再初始化粒子预制）。

================================================================================
七、自动断言（必须全部 PASS）
--------------------------------------------------------------------------------
- fireRate 永不低于 0.60s（或购买 FireRateCap 后的新下限）；
- 连发+散射使用 max()；
- 分裂子弹不再分裂且不继承形态技能；
- 穿透/反弹衰减严格生效；
- 波次/生成速递增 + 地板/上限正确；
- 旧存档成功迁移（报表列出迁移数量与失败原因）；
- Boss 每 5 波触发且掉落宝箱；
- Healer 精英的 heal有 CD 与 cap，且 UI 有标识；
- 低性能模式能依据 P95 自动切换/回退；
- RNG 重放三次结果差异在合理波动范围内（例如击杀±15%）。

================================================================================
八、输出（每轮必须打印）
--------------------------------------------------------------------------------
1) 变更清单：新增/修改/覆盖的场景、对象、External、变量与关键事件；
2) 自测报告：
   - QA：Spawn50 / LevelUpTo10 / SpreadTest / 压力测试 / 触摸连点 / RNG 重放 的 avg FPS / p95 FPS / min fireRate / totalMultiplier / 击杀统计；
   - 存档迁移结果（成功/失败与原因）；
3) 若仍有 TODO → 列出并在下一轮自动完成。

================================================================================
九、CHANGELOG & 版本自动化（若存在则启用）
--------------------------------------------------------------------------------
- 若仓库根存在 CHANGELOG.template.md 与 Codex_Changelog_AutoPrompt.txt，执行完自动更新 CHANGELOG.md 与 VERSION，并以 Conventional Commits 写提交。

（完）
